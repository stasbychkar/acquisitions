version: '3.8'

services:
    # Application Service (Production)
    app:
        build:
            context: .
            dockerfile: Dockerfile
            target: production
        container_name: acquisitions-app-prod
        ports:
            - '3000:3000'
        env_file:
            - .env.production
        networks:
            - acquisitions-prod-network
        restart: unless-stopped
        healthcheck:
            test:
                [
                    'CMD',
                    'wget',
                    '--no-verbose',
                    '--tries=1',
                    '--spider',
                    'http://localhost:3000/health',
                ]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 30s
        # Security: Run as non-root user (defined in Dockerfile)
        # Logging driver for production
        logging:
            driver: 'json-file'
            options:
                max-size: '10m'
                max-file: '3'
        # Resource limits for production
        deploy:
            resources:
                limits:
                    cpus: '1.0'
                    memory: 512M
                reservations:
                    cpus: '0.5'
                    memory: 256M
            restart_policy:
                condition: on-failure
                delay: 5s
                max_attempts: 3
                window: 120s

    # Optional: Reverse proxy (Nginx) for production
    nginx:
        image: nginx:alpine
        container_name: acquisitions-nginx-prod
        ports:
            - '80:80'
            - '443:443'
        volumes:
            - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
            - ./nginx/ssl:/etc/nginx/ssl:ro # SSL certificates
        depends_on:
            - app
        networks:
            - acquisitions-prod-network
        restart: unless-stopped
        healthcheck:
            test:
                [
                    'CMD',
                    'wget',
                    '--no-verbose',
                    '--tries=1',
                    '--spider',
                    'http://localhost:80',
                ]
            interval: 30s
            timeout: 10s
            retries: 3

networks:
    acquisitions-prod-network:
        driver: bridge
        name: acquisitions-prod-network
